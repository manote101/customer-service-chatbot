## Database Schema

This document describes the PostgreSQL schema for storing customer chat sessions, message transcripts, and support handoffs.

Conventions:
- Primary keys are `UUID` (generated by application).
- Timestamps use `TIMESTAMPTZ`.
- Soft deletion is avoided for MVP; prefer immutable transcripts + explicit retention policy.
- PII should be minimized; store references (IDs) where possible.

### Table: users
- id: UUID (primary key)
- email: string (unique)
- external_id: string (nullable) — user id from your main product system/IdP
- is_authenticated: boolean (default false)
- created_at: TIMESTAMPTZ (default now)
- updated_at: TIMESTAMPTZ (default now)

Indexes / Constraints:
- unique(email)
- index(external_id)

Notes:
- If you already have a user table in another system, you may omit `email` and store only `external_id`.

### Table: conversations
- id: UUID (primary key)
- user_id: UUID (foreign key -> users.id, nullable)
- session_id: string (unique) — aligns with API `session_id` for continuity
- channel: string (default "web") — e.g., web, sms, whatsapp
- locale: string (nullable) — e.g., en-US
- status: string (default "open") — open, closed
- started_at: TIMESTAMPTZ (default now)
- ended_at: TIMESTAMPTZ (nullable)
- created_at: TIMESTAMPTZ (default now)
- updated_at: TIMESTAMPTZ (default now)

Indexes / Constraints:
- unique(session_id)
- index(user_id)
- index(started_at)

Notes:
- `user_id` is nullable to support guest users.

### Table: messages
- id: UUID (primary key)
- conversation_id: UUID (foreign key -> conversations.id)
- role: string — user, assistant, system
- content: text
- created_at: TIMESTAMPTZ (default now)

Optional fields (recommended for future iterations):
- intent: string (nullable)
- confidence: numeric (nullable)
- metadata: jsonb (nullable) — e.g., extracted entities, tool calls

Indexes / Constraints:
- index(conversation_id, created_at)
- check(role in ('user','assistant','system'))

Notes:
- Keep messages append-only; never overwrite content.

### Table: handoffs
Tracks escalation recommendations and/or ticket creation.

- id: UUID (primary key)
- conversation_id: UUID (foreign key -> conversations.id)
- recommended: boolean
- reason: string (nullable)
- provider: string (nullable) — e.g., zendesk, freshdesk, email
- ticket_id: string (nullable) — external ticket identifier
- status: string (default "pending") — pending, created, routed, resolved, failed
- created_at: TIMESTAMPTZ (default now)
- updated_at: TIMESTAMPTZ (default now)

Indexes / Constraints:
- index(conversation_id)
- index(ticket_id)

Notes:
- This table maps to the API response `handoff` object.

### Table: feedback
Captures CSAT / thumbs-up-down style feedback at the end of a chat.

- id: UUID (primary key)
- conversation_id: UUID (foreign key -> conversations.id)
- rating: integer — e.g., 1–5 or 0/1 depending on your UX
- comment: text (nullable)
- created_at: TIMESTAMPTZ (default now)

Indexes / Constraints:
- unique(conversation_id) — at most one feedback entry per conversation (MVP)
- check(rating >= 0)

### Table: api_requests (optional)
Useful for debugging, rate-limiting, and tracing without storing full PII.

- id: UUID (primary key)
- conversation_id: UUID (foreign key -> conversations.id, nullable)
- endpoint: string — e.g., /api/v1/chat
- status_code: integer
- latency_ms: integer (nullable)
- created_at: TIMESTAMPTZ (default now)

Indexes / Constraints:
- index(created_at)
- index(endpoint, created_at)

## Relationships (ER overview)
- users (1) -> conversations (many)
- conversations (1) -> messages (many)
- conversations (1) -> handoffs (many) (usually 0–1 in MVP)
- conversations (1) -> feedback (0–1)

## Data Retention & Privacy
- Transcripts can contain sensitive information; define a retention window (e.g., 30–90 days) and implement scheduled deletion or archival.
- Avoid logging raw message content outside the `messages` table.
- Consider redacting secrets (credit cards, passwords) before persisting `messages.content`.